<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Graph Editor Demo - Umbilical Component</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      padding: 20px;
      background: #2c3e50;
      color: white;
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 0;
      opacity: 0.8;
      font-size: 14px;
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      padding: 15px 20px;
      background: #ecf0f1;
      border-bottom: 1px solid #bdc3c7;
      flex-wrap: wrap;
    }
    
    .toolbar-group {
      display: flex;
      gap: 5px;
      align-items: center;
      padding-right: 15px;
      border-right: 1px solid #bdc3c7;
    }
    
    .toolbar-group:last-child {
      border-right: none;
    }
    
    button {
      padding: 6px 12px;
      border: 1px solid #95a5a6;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #ecf0f1;
      border-color: #7f8c8d;
    }
    
    button:active:not(:disabled) {
      transform: translateY(1px);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button.primary {
      background: #3498db;
      color: white;
      border-color: #2980b9;
    }
    
    button.primary:hover:not(:disabled) {
      background: #2980b9;
    }
    
    button.danger {
      background: #e74c3c;
      color: white;
      border-color: #c0392b;
    }
    
    button.danger:hover:not(:disabled) {
      background: #c0392b;
    }
    
    .main-content {
      display: flex;
      height: 600px;
    }
    
    .editor-container {
      flex: 1;
      position: relative;
      background: #fafafa;
    }
    
    .sidebar {
      width: 300px;
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }
    
    .panel {
      padding: 15px;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      text-transform: uppercase;
      color: #7f8c8d;
      font-weight: 500;
    }
    
    .status {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #34495e;
      margin-bottom: 5px;
    }
    
    .status-value {
      font-weight: 500;
      color: #2c3e50;
    }
    
    select {
      width: 100%;
      padding: 6px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 13px;
      background: white;
    }
    
    .graph-editor {
      width: 100%;
      height: 100%;
    }
    
    .graph-editor svg {
      background: white;
    }
    
    .graph-editor--dark svg {
      background: #2c3e50;
    }
    
    /* Tool-specific cursors */
    .tool-pan { cursor: grab; }
    .tool-pan:active { cursor: grabbing; }
    .tool-select { cursor: default; }
    
    /* Keyboard shortcuts help */
    .shortcuts {
      font-size: 12px;
      color: #7f8c8d;
    }
    
    .shortcuts kbd {
      display: inline-block;
      padding: 2px 6px;
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      border-radius: 3px;
      font-family: monospace;
      font-size: 11px;
    }
    
    .log {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      font-family: monospace;
      padding: 10px;
      background: #f8f9fa;
    }
    
    .log-entry {
      padding: 2px 0;
      color: #34495e;
    }
    
    .log-entry.error {
      color: #e74c3c;
    }
    
    .log-entry.info {
      color: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Graph Editor Component Demo</h1>
      <p>Interactive node-link diagram editor using the Umbilical Component Protocol</p>
    </div>
    
    <div class="toolbar">
      <div class="toolbar-group">
        <button id="selectToolBtn" class="primary">Select</button>
        <button id="panToolBtn">Pan</button>
      </div>
      
      <div class="toolbar-group">
        <button id="addNodeBtn">Add Node</button>
        <button id="deleteBtn" class="danger" disabled>Delete Selected</button>
        <button id="connectBtn" disabled>Connect Selected</button>
      </div>
      
      <div class="toolbar-group">
        <button id="undoBtn" disabled>Undo</button>
        <button id="redoBtn" disabled>Redo</button>
      </div>
      
      <div class="toolbar-group">
        <button id="layoutBtn">Auto Layout</button>
        <button id="fitBtn">Fit to View</button>
        <button id="resetBtn">Reset Zoom</button>
      </div>
      
      <div class="toolbar-group">
        <select id="rendererSelect">
          <option value="svg">SVG Renderer</option>
          <option value="canvas">Canvas Renderer</option>
        </select>
        <select id="themeSelect">
          <option value="light">Light Theme</option>
          <option value="dark">Dark Theme</option>
        </select>
      </div>
      
      <div class="toolbar-group">
        <button id="saveBtn">Save</button>
        <button id="loadBtn">Load</button>
        <button id="clearBtn" class="danger">Clear All</button>
      </div>
    </div>
    
    <div class="main-content">
      <div class="editor-container" id="editorContainer"></div>
      
      <div class="sidebar">
        <div class="panel">
          <h3>Status</h3>
          <div class="status">
            <span>Nodes:</span>
            <span class="status-value" id="nodeCount">0</span>
          </div>
          <div class="status">
            <span>Edges:</span>
            <span class="status-value" id="edgeCount">0</span>
          </div>
          <div class="status">
            <span>Selected:</span>
            <span class="status-value" id="selectionCount">0</span>
          </div>
          <div class="status">
            <span>Tool:</span>
            <span class="status-value" id="activeTool">select</span>
          </div>
          <div class="status">
            <span>Zoom:</span>
            <span class="status-value" id="zoomLevel">100%</span>
          </div>
        </div>
        
        <div class="panel">
          <h3>Keyboard Shortcuts</h3>
          <div class="shortcuts">
            <div><kbd>Delete</kbd> Delete selected</div>
            <div><kbd>Ctrl+Z</kbd> Undo</div>
            <div><kbd>Ctrl+Y</kbd> Redo</div>
            <div><kbd>Ctrl+A</kbd> Select all</div>
            <div><kbd>Escape</kbd> Clear selection</div>
            <div><kbd>Space</kbd> Pan mode</div>
          </div>
        </div>
        
        <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
          <h3>Event Log</h3>
          <div class="log" id="eventLog"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { GraphEditor } from '/src/components/graph-editor/index.js';
    import { PanTool } from '/src/components/graph-editor/tools/PanTool.js';
    import { SelectTool } from '/src/components/graph-editor/tools/SelectTool.js';
    
    // Initialize demo
    let editor = null;
    let nodeIdCounter = 1;
    
    // Log helper
    function log(message, type = 'info') {
      const logEl = document.getElementById('eventLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    // Update status display
    function updateStatus() {
      if (!editor) return;
      
      const model = editor.getModel();
      const viewModel = editor.getViewModel();
      const view = editor.getView();
      
      document.getElementById('nodeCount').textContent = 
        model.getSceneGraph().getAllNodes().length - 1; // Exclude root
      document.getElementById('edgeCount').textContent = 
        model.getEdges().length;
      document.getElementById('selectionCount').textContent = 
        viewModel.getSelection().length;
      document.getElementById('activeTool').textContent = 
        viewModel.getEventCoordinator().getActiveTool();
      document.getElementById('zoomLevel').textContent = 
        Math.round(view.getViewport().getZoom() * 100) + '%';
        
      // Update button states
      document.getElementById('undoBtn').disabled = !viewModel.canUndo();
      document.getElementById('redoBtn').disabled = !viewModel.canRedo();
      
      const hasSelection = viewModel.getSelection().length > 0;
      document.getElementById('deleteBtn').disabled = !hasSelection;
      document.getElementById('connectBtn').disabled = viewModel.getSelection().length !== 2;
    }
    
    // Create graph editor
    function createEditor() {
      try {
        console.log('Creating graph editor...');
        const container = document.getElementById('editorContainer');
        
        if (!container) {
          throw new Error('Could not find editorContainer element');
        }
        
        console.log('Container found:', container);
        
        editor = GraphEditor.create({
        dom: container,
        theme: 'light',
        onModelChange: (type, data) => {
          log(`Model change: ${type}`);
          updateStatus();
        },
        onSelectionChange: (selection) => {
          log(`Selection changed: ${selection.join(', ') || 'none'}`);
          updateStatus();
        },
        onHistoryChange: (state) => {
          updateStatus();
        },
        onMount: (instance) => {
          console.log('onMount called with instance:', instance);
          log('Graph editor mounted');
          setupTools(instance);
          createSampleGraph(instance);
          updateStatus();
        },
        onError: (error) => {
          console.error('GraphEditor onError:', error);
          log(`Error: ${error.message}`, 'error');
        }
      });
      
      console.log('GraphEditor.create returned:', editor);
      
      } catch (error) {
        console.error('Error in createEditor:', error);
        log(`Initialization error: ${error.message}`, 'error');
      }
    }
    
    // Setup tools
    function setupTools(editorInstance) {
      try {
        console.log('Setting up tools...');
        const coordinator = editorInstance.getViewModel().getEventCoordinator();
        
        // Register tools
        coordinator.registerTool('select', new SelectTool());
        coordinator.registerTool('pan', new PanTool());
        
        // Set default tool
        coordinator.setActiveTool('select');
        updateToolButtons('select');
        console.log('Tools setup complete');
      } catch (error) {
        console.error('Error in setupTools:', error);
        log(`Tool setup error: ${error.message}`, 'error');
      }
    }
    
    // Create sample graph
    function createSampleGraph(editorInstance) {
      try {
        const editorToUse = editorInstance || editor;
        if (!editorToUse) {
          console.warn('No editor available for createSampleGraph');
          return;
        }
        
        console.log('Creating sample graph...');
        const model = editorToUse.getModel();
      
      // Create nodes with better positioning
      model.addNode({
        id: 'start',
        position: { x: 150, y: 100 },
        label: 'Start',
        size: { width: 100, height: 60 },
        style: { fill: '#e3f2fd', stroke: '#1976d2', strokeWidth: 2 }
      });
      
      model.addNode({
        id: 'process1',
        position: { x: 350, y: 100 },
        label: 'Process A',
        size: { width: 120, height: 60 },
        style: { fill: '#f3e5f5', stroke: '#7b1fa2', strokeWidth: 2 }
      });
      
      model.addNode({
        id: 'process2',
        position: { x: 350, y: 220 },
        label: 'Process B',
        size: { width: 120, height: 60 },
        style: { fill: '#e8f5e8', stroke: '#388e3c', strokeWidth: 2 }
      });
      
      model.addNode({
        id: 'decision',
        position: { x: 550, y: 160 },
        label: 'Decision',
        size: { width: 100, height: 60 },
        style: { fill: '#fff3e0', stroke: '#f57c00', strokeWidth: 2 }
      });
      
      model.addNode({
        id: 'end',
        position: { x: 700, y: 160 },
        label: 'End',
        size: { width: 100, height: 60 },
        style: { fill: '#ffebee', stroke: '#d32f2f', strokeWidth: 2 }
      });
      
      // Create edges with labels
      model.addEdge({
        id: 'edge1',
        source: 'start',
        target: 'process1',
        label: 'begin',
        directed: true
      });
      
      model.addEdge({
        id: 'edge2', 
        source: 'start',
        target: 'process2',
        label: 'alternate',
        directed: true
      });
      
      model.addEdge({
        id: 'edge3',
        source: 'process1',
        target: 'decision',
        directed: true
      });
      
      model.addEdge({
        id: 'edge4',
        source: 'process2', 
        target: 'decision',
        directed: true
      });
      
      model.addEdge({
        id: 'edge5',
        source: 'decision',
        target: 'end',
        label: 'complete',
        directed: true
      });
      
      // Update counter to avoid ID conflicts
      nodeIdCounter = 10;
      
      log('Created sample graph with 5 nodes and 5 edges');
      
      // Trigger initial render
      editorToUse.getViewModel().render();
      console.log('Sample graph created and rendered successfully');
      
      } catch (error) {
        console.error('Error in createSampleGraph:', error);
        log(`Sample graph error: ${error.message}`, 'error');
      }
    }
    
    // Update tool button states
    function updateToolButtons(activeTool) {
      document.getElementById('selectToolBtn').classList.toggle('primary', activeTool === 'select');
      document.getElementById('panToolBtn').classList.toggle('primary', activeTool === 'pan');
      
      // Update cursor
      if (editor) {
        const container = editor.getView().getContainer();
        container.classList.remove('tool-select', 'tool-pan');
        container.classList.add(`tool-${activeTool}`);
      }
    }
    
    // Tool button handlers
    document.getElementById('selectToolBtn').addEventListener('click', () => {
      if (!editor) return;
      const coordinator = editor.getViewModel().getEventCoordinator();
      coordinator.setActiveTool('select');
      updateToolButtons('select');
      log('Switched to select tool');
    });
    
    document.getElementById('panToolBtn').addEventListener('click', () => {
      const coordinator = editor.getViewModel().getEventCoordinator();
      coordinator.setActiveTool('pan');
      updateToolButtons('pan');
      log('Switched to pan tool');
    });
    
    // Action button handlers
    document.getElementById('addNodeBtn').addEventListener('click', () => {
      try {
        console.log('Add Node button clicked');
        
        if (!editor) {
          console.error('No editor available');
          log('No editor available', 'error');
          return;
        }
        
        console.log('Editor available:', editor);
        const viewModel = editor.getViewModel();
        const viewport = editor.getView().getViewport();
        
        // Add node at center of viewport
        const center = {
          x: 400 + Math.random() * 100 - 50,
          y: 300 + Math.random() * 100 - 50
        };
        
        const nodeId = `node${nodeIdCounter++}`;
        console.log(`Creating node: ${nodeId} at`, center);
        
        const result = viewModel.executeCommandType('addNode', {
          nodeData: {
            id: nodeId,
            position: center,
            label: `Node ${nodeIdCounter}`,
            size: { width: 100, height: 60 }
          }
        });
        
        console.log('Add node result:', result);
        log(`Added node: ${nodeId}`);
        
      } catch (error) {
        console.error('Error in Add Node button:', error);
        log(`Add node error: ${error.message}`, 'error');
      }
    });
    
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!editor) return;
      const viewModel = editor.getViewModel();
      const selection = viewModel.getSelection();
      
      selection.forEach(nodeId => {
        viewModel.executeCommandType('removeNode', { nodeId });
      });
    });
    
    document.getElementById('connectBtn').addEventListener('click', () => {
      if (!editor) return;
      const viewModel = editor.getViewModel();
      const selection = viewModel.getSelection();
      
      if (selection.length === 2) {
        viewModel.executeCommandType('connectNodes', {
          sourceNodeId: selection[0],
          targetNodeId: selection[1],
          edgeData: {
            id: `edge${Date.now()}`,
            directed: true
          }
        });
      }
    });
    
    // Undo/Redo
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (!editor) return;
      editor.getViewModel().undo();
    });
    
    document.getElementById('redoBtn').addEventListener('click', () => {
      if (!editor) return;
      editor.getViewModel().redo();
    });
    
    // View controls
    document.getElementById('layoutBtn').addEventListener('click', () => {
      if (!editor) return;
      editor.getViewModel().applyLayout('dagre');
      log('Applied auto layout');
    });
    
    document.getElementById('fitBtn').addEventListener('click', () => {
      // TODO: Implement fit to view
      log('Fit to view not yet implemented');
    });
    
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!editor) return;
      editor.getView().getViewport().reset();
      log('Reset viewport');
    });
    
    // Renderer and theme
    document.getElementById('rendererSelect').addEventListener('change', async (e) => {
      if (!editor) return;
      await editor.getView().setRendererType(e.target.value);
      log(`Switched to ${e.target.value} renderer`);
    });
    
    document.getElementById('themeSelect').addEventListener('change', (e) => {
      if (!editor) return;
      const container = editor.getView().getContainer();
      const editorEl = container.querySelector('.graph-editor');
      if (e.target.value === 'dark') {
        editorEl.classList.add('graph-editor--dark');
      } else {
        editorEl.classList.remove('graph-editor--dark');
      }
      log(`Switched to ${e.target.value} theme`);
    });
    
    // Save/Load
    document.getElementById('saveBtn').addEventListener('click', () => {
      if (!editor) return;
      const data = editor.getModel().toJSON();
      const json = JSON.stringify(data, null, 2);
      
      // Download as file
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'graph.json';
      a.click();
      URL.revokeObjectURL(url);
      
      log('Graph saved');
    });
    
    document.getElementById('loadBtn').addEventListener('click', () => {
      if (!editor) return;
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (editor) {
                editor.getModel().fromJSON(data);
              }
              log('Graph loaded successfully');
            } catch (error) {
              log(`Error loading graph: ${error.message}`, 'error');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    });
    
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (!editor) return;
      if (confirm('Clear all nodes and edges?')) {
        editor.getModel().clear();
        nodeIdCounter = 1;
        log('Graph cleared');
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (!editor) return;
      
      const viewModel = editor.getViewModel();
      
      // Delete
      if (e.key === 'Delete' && !e.ctrlKey && !e.metaKey) {
        const selection = viewModel.getSelection();
        selection.forEach(nodeId => {
          viewModel.executeCommandType('removeNode', { nodeId });
        });
      }
      
      // Undo/Redo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        viewModel.undo();
      }
      
      if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        viewModel.redo();
      }
      
      // Select all
      if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        const allNodes = editor.getModel().getSceneGraph().getAllNodes()
          .filter(n => n.getId() !== 'root')
          .map(n => n.getId());
        viewModel.clearSelection();
        allNodes.forEach(id => viewModel.selectNode(id, true));
      }
      
      // Clear selection
      if (e.key === 'Escape') {
        viewModel.clearSelection();
      }
      
      // Pan mode
      if (e.key === ' ' && !e.repeat) {
        e.preventDefault();
        const coordinator = viewModel.getEventCoordinator();
        coordinator.setActiveTool('pan');
        updateToolButtons('pan');
      }
    });
    
    document.addEventListener('keyup', (e) => {
      if (!editor) return;
      
      // Return to select mode when releasing space
      if (e.key === ' ') {
        const coordinator = editor.getViewModel().getEventCoordinator();
        coordinator.setActiveTool('select');
        updateToolButtons('select');
      }
    });
    
    // Initialize
    createEditor();
  </script>
</body>
</html>